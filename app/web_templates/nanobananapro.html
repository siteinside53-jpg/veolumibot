<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeoLumi – Nano Banana Pro</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
:root{
  --bg:#0b0c12;
  --card:#121422;
  --card2:#0f1020;
  --text:#e9e9f5;
  --muted:#a4a7c0;
  --stroke:#242646;
  --accent:#7c3aed;
  --accent2:#6d28d9;
  --good:#19c37d;
  --bad:#ef4444;
  --shadow: 0 14px 40px rgba(0,0,0,.55);
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
  background:
    radial-gradient(800px 500px at 20% 10%, rgba(124,58,237,.18), transparent 55%),
    radial-gradient(700px 500px at 80% 40%, rgba(124,58,237,.12), transparent 60%),
    var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  padding:18px 14px 28px;
}
.wrap{width:min(520px, 100%);max-width:none;margin:0 auto;padding:0}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid rgba(255,255,255,.06);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow:hidden;
  padding:16px;
}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
h2{margin:0;font-size:18px;letter-spacing:.2px}
label{display:block;font-weight:800;margin:12px 0 6px;color:var(--text);opacity:.92}
select,textarea,input[type="file"]{
  width:100%;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  color: var(--text);
  padding:12px;
  outline:none;
  font-size:14px;
  font-weight:700;
  line-height:1.35;
}
textarea{resize:vertical;min-height:140px;height:140px}
select:focus, textarea:focus, input[type="file"]:focus{
  border-color: rgba(124,58,237,.55);
  box-shadow: 0 0 0 4px rgba(124,58,237,.15);
}
.btn{
  margin-top:12px;
  width:100%;
  padding:14px 16px;
  border-radius:16px;
  border:0;
  background: linear-gradient(180deg, var(--accent), var(--accent2));
  color:white;
  font-weight:900;
  cursor:pointer;
  box-shadow: 0 12px 22px rgba(124,58,237,.25);
  letter-spacing:.2px;
  font-size:15px;
}
.btn:active{transform: translateY(1px)}
.btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}
.price-line{
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.06);
  background: rgba(0,0,0,.18);
  color:var(--muted);
  font-weight:800;
}
.price-line .price{font-size:18px;color:var(--text);font-weight:900}
.hint{margin-top:8px;color:var(--muted);font-weight:700;font-size:13px;line-height:1.35}
.err{color: rgba(239,68,68,.95);font-weight:900;display:none;margin-top:6px;white-space:pre-wrap}
.ok{color: rgba(25,195,125,.95);font-weight:900;display:none;margin-top:6px;white-space:pre-wrap}
.row > div{color:var(--muted);font-weight:700}
.row > div b{color:var(--text)}
input[type="file"]{
  border-style:dashed;
  border-color: rgba(255,255,255,.16);
}
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Nano Banana Pro</h2>
        <div>Κόστος: <b>4 credits</b></div>
      </div>

      <label for="prompt">Prompt</label>
      <textarea id="prompt" maxlength="3000" placeholder="Πληκτρολόγησε prompt (έως 3000 χαρακτήρες)..."></textarea>
      <div id="promptErr" class="err">Το prompt είναι υποχρεωτικό (1–3000 χαρακτήρες).</div>

      <label for="images">Εικόνες (προαιρετικά)</label>
      <input id="images" type="file" accept="image/png,image/jpeg,image/jpg" multiple />
      <div class="hint">Έως 8 εικόνες. Έως 10MB/εικόνα. JPG/PNG.</div>
      <div id="imgErr" class="err"></div>

      <label for="ratio">Αναλογία πλευρών</label>
      <select id="ratio">
        <option value="1:1" selected>1:1</option>
        <option value="2:3">2:3</option>
        <option value="3:2">3:2</option>
        <option value="3:4">3:4</option>
        <option value="4:3">4:3</option>
        <option value="4:5">4:5</option>
        <option value="5:4">5:4</option>
        <option value="9:16">9:16</option>
        <option value="16:9">16:9</option>
        <option value="21:9">21:9</option>
      </select>

      <label for="quality">Ποιότητα (resolution)</label>
      <select id="quality">
        <option value="1k" selected>1K</option>
        <option value="2k">2K</option>
        <option value="4k">4K</option>
      </select>

      <label for="format">Μορφή αρχείου</label>
      <select id="format">
        <option value="png" selected>PNG</option>
        <option value="jpg">JPG</option>
      </select>

      <div class="price-line">
        <div>Κόστος</div><div class="price">4 credits</div>
      </div>

      <button class="btn" id="btnGenerate">Δημιουργία</button>
      <div class="hint">Θα εμφανιστεί popup “στάλθηκε” και το αποτέλεσμα θα έρθει μέσα στο Telegram chat.</div>

      <div id="okBox" class="ok"></div>
      <div id="errBox" class="err"></div>
    </div>
  </div>


<script>
  const $ = id => document.getElementById(id);
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.ready(); }

  const API_ENDPOINT = "/api/nanobanana-pro/generate";

  function showSentPopup(){
    if (!tg?.showPopup) return;
    tg.showPopup({
      title: "Telegram",
      message: "Η αίτηση στάλθηκε. Το αποτέλεσμα θα έρθει μέσα στο Telegram.",
      buttons: [{ type: "ok", text: "Close" }]
    }, () => {});
  }
  function showAlert(msg){
    if (tg?.showAlert) tg.showAlert(msg);
  }

  function validateFiles(fileList){
    if (!fileList || fileList.length === 0) return { ok:true };
    if (fileList.length > 8) return { ok:false, error:"Μέγιστο 8 εικόνες." };
    for (const f of fileList){
      const max = 10 * 1024 * 1024;
      if (f.size > max) return { ok:false, error:`Η εικόνα "${f.name}" είναι πάνω από 10MB.` };
      const t = (f.type || "").toLowerCase();
      if (!(t.includes("png") || t.includes("jpeg") || t.includes("jpg") || t.startsWith("image/")))
        return { ok:false, error:`Η εικόνα "${f.name}" δεν είναι PNG/JPG.` };
    }
    return { ok:true };
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = () => reject(new Error("File read failed"));
      reader.readAsDataURL(file);
    });
  }

  async function generate(){
    $("okBox").style.display = "none";
    $("errBox").style.display = "none";
    $("promptErr").style.display = "none";
    $("imgErr").style.display = "none";

    const prompt = $("prompt").value.trim();
    if (prompt.length < 1 || prompt.length > 3000){
      $("promptErr").style.display = "block";
      return;
    }

    const files = $("images").files;
    const vf = validateFiles(files);
    if (!vf.ok){
      $("imgErr").textContent = vf.error;
      $("imgErr").style.display = "block";
      return;
    }

    $("btnGenerate").disabled = true;
    $("btnGenerate").textContent = "⏳ Αποστολή...";

    showSentPopup();

    try{
      // Convert images to data URLs (max 8)
      let images_data_urls = [];
      if (files && files.length){
        const arr = Array.from(files).slice(0, 8);
        images_data_urls = await Promise.all(arr.map(fileToDataURL));
      }

      // Map UI -> backend expected fields
      const sizeMap = { "1k":"1K", "2k":"2K", "4k":"4K" };
      const payload = {
        initData: tg?.initData || "",
        prompt,
        aspect_ratio: $("ratio").value,
        image_size: sizeMap[String($("quality").value).toLowerCase()] || "1K",
        output_format: $("format").value,
        images_data_urls,
      };

      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok){
        const msg = data?.error || data?.detail || "Αποτυχία δημιουργίας.";
        throw new Error(msg);
      }

      $("okBox").textContent = data.message || "Έτοιμο. Στάλθηκε στο Telegram.";
      $("okBox").style.display = "block";

      if (tg?.close) tg.close();

    }catch(e){
      showAlert("Αποτυχία. " + (e?.message || ""));
      $("errBox").textContent = "Σφάλμα: " + (e?.message || "Άγνωστο σφάλμα");
      $("errBox").style.display = "block";
    }finally{
      $("btnGenerate").disabled = false;
      $("btnGenerate").textContent = "Δημιουργία";
    }
  }

  $("btnGenerate").addEventListener("click", generate);
</script>
</script>
</body>
</html>
