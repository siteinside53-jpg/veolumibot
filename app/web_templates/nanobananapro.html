<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeoLumi – Nano Banana Pro</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0c12;
      --card:#121422;
      --card2:#0f1020;
      --text:#e9e9f5;
      --muted:#a4a7c0;
      --stroke:#242646;
      --accent:#7c3aed;
      --accent2:#6d28d9;
      --good:#19c37d;
      --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(800px 500px at 20% 10%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(700px 500px at 80% 40%, rgba(124,58,237,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:18px 14px 28px;
      overflow-x:hidden; /* για να μην “σπάει” κάτι */
    }
    .wrap{width:min(520px, 100%)}

    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:8px 6px 14px;
      color:var(--muted);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; color:var(--text);
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(124,58,237,.35));
      display:grid; place-items:center;
      box-shadow: 0 10px 20px rgba(124,58,237,.25);
      border:1px solid rgba(255,255,255,.08);
      flex:0 0 auto;
    }
    .logo svg{opacity:.95}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden; /* important */
    }
    .card-inner{padding:16px}
    .section-title{
      font-size:15px;
      font-weight:700;
      margin:2px 0 10px;
    }
    .section-sub{font-size:13px; color:var(--muted); margin:0 0 10px}

    .block{
      margin-top:12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding:12px;
    }
    .label-row{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
      color:var(--muted);
      font-size:12px;
    }
    .small{font-size:12px; color:var(--muted)}
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea:focus{border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 4px rgba(124,58,237,.15)}

    select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
      appearance:none;
    }
    select:focus{border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 4px rgba(124,58,237,.15)}
    .select-wrap{position:relative}
    .select-wrap:after{
      content:"▾";
      position:absolute;
      right:12px; top:50%;
      transform:translateY(-50%);
      color:rgba(233,233,245,.75);
      pointer-events:none;
      font-size:14px;
    }

    .uploader{
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .upload-icon{
      width:36px; height:36px; border-radius:12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .upload-meta{flex:1}
    .upload-meta .h{font-weight:700; font-size:13px}
    .upload-meta .p{font-size:12px; color:var(--muted); margin-top:2px}
    .btn{
      border:0;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight:800;
      border-radius: 14px;
      padding:11px 14px;
      cursor:pointer;
      box-shadow: 0 12px 22px rgba(124,58,237,.25);
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.65; cursor:not-allowed}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      box-shadow:none;
      border:1px solid rgba(255,255,255,.12);
    }

    .thumbs{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .thumb{
      position:relative;
      border-radius: 12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      aspect-ratio: 1 / 1;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .x{
      position:absolute;
      top:6px; right:6px;
      width:22px; height:22px;
      border-radius:999px;
      border:0;
      background: rgba(0,0,0,.55);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      line-height:22px;
      display:grid; place-items:center;
    }
    .thumb.add{
      display:grid;
      place-items:center;
      color:rgba(233,233,245,.85);
      cursor:pointer;
    }
    .thumb.add .plus{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-weight:900;
    }
    .thumb.add .plus .p{font-size:11px; color:rgba(233,233,245,.7); font-weight:700}

    .cost{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    .cost .left{color:var(--muted); font-size:12px}
    .cost .right{font-size:18px; font-weight:900}

    .footer{margin-top:12px}
    .big-generate{
      width:100%;
      padding:14px 16px;
      border-radius: 16px;
      font-size:15px;
      letter-spacing:.2px;
    }

    .err{
      display:none;
      margin-top:8px;
      font-size:13px;
      color:rgba(239,68,68,.95);
      border:1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      padding:10px 12px;
      border-radius: 14px;
      white-space:pre-wrap;
    }
    .ok{
      display:none;
      margin-top:8px;
      font-size:13px;
      color:rgba(25,195,125,.95);
      border:1px solid rgba(25,195,125,.25);
      background: rgba(25,195,125,.08);
      padding:10px 12px;
      border-radius: 14px;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Nano Banana Pro</h2>
        <div>Κόστος: <b>4 credits</b></div>
      </div>

      <label for="prompt">Prompt</label>
      <textarea id="prompt" maxlength="3000" placeholder="Πληκτρολόγησε prompt (έως 3000 χαρακτήρες)..."></textarea>
      <div id="promptErr" class="err">Το prompt είναι υποχρεωτικό (1–3000 χαρακτήρες).</div>

      <label for="images">Εικόνες (προαιρετικά)</label>
      <input id="images" type="file" accept="image/png,image/jpeg,image/jpg" multiple />
      <div class="hint">Έως 8 εικόνες. Έως 10MB/εικόνα. JPG/PNG.</div>
      <div id="imgErr" class="err"></div>

      <label for="ratio">Αναλογία πλευρών</label>
      <select id="ratio">
        <option value="1:1" selected>1:1</option>
        <option value="2:3">2:3</option>
        <option value="3:2">3:2</option>
        <option value="3:4">3:4</option>
        <option value="4:3">4:3</option>
        <option value="4:5">4:5</option>
        <option value="5:4">5:4</option>
        <option value="9:16">9:16</option>
        <option value="16:9">16:9</option>
        <option value="21:9">21:9</option>
      </select>

      <label for="quality">Ποιότητα (resolution)</label>
      <select id="quality">
        <option value="1k" selected>1K</option>
        <option value="2k">2K</option>
        <option value="4k">4K</option>
      </select>

      <label for="format">Μορφή αρχείου</label>
      <select id="format">
        <option value="png" selected>PNG</option>
        <option value="jpg">JPG</option>
      </select>

      <div class="price-line">
        <div>Κόστος</div><div class="price">4 credits</div>
      </div>

      <button class="btn" id="btnGenerate">Δημιουργία</button>
      <div class="hint">Θα εμφανιστεί popup “στάλθηκε” και το αποτέλεσμα θα έρθει μέσα στο Telegram chat.</div>

      <div id="okBox" class="ok"></div>
      <div id="errBox" class="err"></div>
    </div>
  </div>


<script>
  const $ = id => document.getElementById(id);
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.ready(); }

  const API_ENDPOINT = "/api/nanobanana-pro/generate";

  function showSentPopup(){
    if (!tg?.showPopup) return;
    tg.showPopup({
      title: "Telegram",
      message: "Η αίτηση στάλθηκε. Το αποτέλεσμα θα έρθει μέσα στο Telegram.",
      buttons: [{ type: "ok", text: "Close" }]
    }, () => {});
  }
  function showAlert(msg){
    if (tg?.showAlert) tg.showAlert(msg);
  }

  function validateFiles(fileList){
    if (!fileList || fileList.length === 0) return { ok:true };
    if (fileList.length > 8) return { ok:false, error:"Μέγιστο 8 εικόνες." };
    for (const f of fileList){
      const max = 10 * 1024 * 1024;
      if (f.size > max) return { ok:false, error:`Η εικόνα "${f.name}" είναι πάνω από 10MB.` };
      const t = (f.type || "").toLowerCase();
      if (!(t.includes("png") || t.includes("jpeg") || t.includes("jpg") || t.startsWith("image/")))
        return { ok:false, error:`Η εικόνα "${f.name}" δεν είναι PNG/JPG.` };
    }
    return { ok:true };
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = () => reject(new Error("File read failed"));
      reader.readAsDataURL(file);
    });
  }

  async function generate(){
    $("okBox").style.display = "none";
    $("errBox").style.display = "none";
    $("promptErr").style.display = "none";
    $("imgErr").style.display = "none";

    const prompt = $("prompt").value.trim();
    if (prompt.length < 1 || prompt.length > 3000){
      $("promptErr").style.display = "block";
      return;
    }

    const files = $("images").files;
    const vf = validateFiles(files);
    if (!vf.ok){
      $("imgErr").textContent = vf.error;
      $("imgErr").style.display = "block";
      return;
    }

    $("btnGenerate").disabled = true;
    $("btnGenerate").textContent = "⏳ Αποστολή...";

    showSentPopup();

    try{
      // Convert images to data URLs (max 8)
      let images_data_urls = [];
      if (files && files.length){
        const arr = Array.from(files).slice(0, 8);
        images_data_urls = await Promise.all(arr.map(fileToDataURL));
      }

      // Map UI -> backend expected fields
      const sizeMap = { "1k":"1K", "2k":"2K", "4k":"4K" };
      const payload = {
        initData: tg?.initData || "",
        prompt,
        aspect_ratio: $("ratio").value,
        image_size: sizeMap[String($("quality").value).toLowerCase()] || "1K",
        output_format: $("format").value,
        images_data_urls,
      };

      const res = await fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok){
        const msg = data?.error || data?.detail || "Αποτυχία δημιουργίας.";
        throw new Error(msg);
      }

      $("okBox").textContent = data.message || "Έτοιμο. Στάλθηκε στο Telegram.";
      $("okBox").style.display = "block";

      if (tg?.close) tg.close();

    }catch(e){
      showAlert("Αποτυχία. " + (e?.message || ""));
      $("errBox").textContent = "Σφάλμα: " + (e?.message || "Άγνωστο σφάλμα");
      $("errBox").style.display = "block";
    }finally{
      $("btnGenerate").disabled = false;
      $("btnGenerate").textContent = "Δημιουργία";
    }
  }

  $("btnGenerate").addEventListener("click", generate);
</script>
</script>
</body>
</html>
