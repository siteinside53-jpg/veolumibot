<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Grok Imagine</title>
  <style>
    :root{
      --bg:#0b0c12;
      --card:#121422;
      --card2:#0f1020;
      --text:#e9e9f5;
      --muted:#a4a7c0;
      --stroke:#242646;
      --accent:#7c3aed;      /* purple */
      --accent2:#6d28d9;
      --good:#19c37d;
      --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(800px 500px at 20% 10%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(700px 500px at 80% 40%, rgba(124,58,237,.12), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding:18px 14px 28px;
    }
    .wrap{width:min(520px, 100%)}
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:8px 6px 14px;
      color:var(--muted);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700; color:var(--text);
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(124,58,237,.35));
      display:grid; place-items:center;
      box-shadow: 0 10px 20px rgba(124,58,237,.25);
      border:1px solid rgba(255,255,255,.08);
    }
    .logo svg{opacity:.95}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding:16px}
    .section-title{
      font-size:15px;
      font-weight:700;
      margin:2px 0 10px;
    }
    .section-sub{font-size:13px; color:var(--muted); margin:0 0 10px}

    .big-generate{
      width:100%;
      padding:14px 16px;
      border-radius:16px;
      font-size:15px;
      letter-spacing:.2px;
    }

    .block{
      margin-top:12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding:12px;
    }
    .label-row{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
      color:var(--muted);
      font-size:12px;
    }

    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea:focus{border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 4px rgba(124,58,237,.15)}

    /* Selects styled like the rest */
    select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
      line-height:1.35;
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(233,233,245,.75) 50%),
        linear-gradient(135deg, rgba(233,233,245,.75) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% + 1px),
        calc(100% - 12px) calc(50% + 1px);
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }
    select:focus{border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 4px rgba(124,58,237,.15)}

    .btn{
      border:0;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight:800;
      border-radius: 14px;
      padding:11px 14px;
      cursor:pointer;
      box-shadow: 0 12px 22px rgba(124,58,237,.25);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.06);
      box-shadow:none;
      border:1px solid rgba(255,255,255,.12);
      color: var(--text);
    }

    .cost{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    .cost .left{color:var(--muted); font-size:12px}
    .cost .right{font-size:18px; font-weight:900;}

    .small{font-size:12px; color:var(--muted)}
    .footer{margin-top:12px;}
    .actions{display:flex; gap:10px; align-items:center;}
    .actions .btn{flex:1}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M7 14c4-1 6-4 7-8 3 3 4 8 2 12-1 2-4 4-7 4-4 0-6-3-6-6 0-3 2-5 4-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <div>Grok Imagine</div>
          <div class="subtitle">Δημιουργία εικόνας / video</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-inner">
        <div class="section-title">Παράμετροι</div>
        <div class="section-sub">Ρύθμισε τη δημιουργία</div>

        <div class="block">
          <div class="label-row"><div>Λειτουργία</div></div>
          <select id="mode">
            <option value="text">Text to Image</option>
            <option value="image">Image to Image</option>
          </select>

          <div style="margin-top:10px">
            <div class="label-row"><div>Αναλογία πλευρών</div></div>
            <select id="ar">
              <option value="1:1">1:1</option>
              <option value="4:5">4:5</option>
              <option value="3:4">3:4</option>
              <option value="16:9">16:9</option>
              <option value="9:16">9:16</option>
            </select>
          </div>

          <div style="margin-top:10px">
            <div class="label-row"><div>Τόνος / στυλ</div></div>
            <select id="tone">
              <option value="spicy">Spicy</option>
              <option value="neutral">Neutral</option>
              <option value="soft">Soft</option>
              <option value="cinematic">Cinematic</option>
            </select>
          </div>
        </div>

        <div class="block">
          <div class="label-row">
            <div>Prompt</div>
            <div class="small"><span id="charCount">0</span>/5000</div>
          </div>
          <textarea id="prompt" maxlength="5000" placeholder="Περιέγραψε τι θέλεις να δημιουργηθεί…"></textarea>
        </div>

        <div class="block">
          <div class="cost" aria-label="cost">
            <div class="left">
              Κόστος<br />
              <span class="small">ανά δημιουργία</span>
            </div>
            <div class="right"><span id="costValue">0.8</span> credits</div>
          </div>

          <div class="footer">
            <div class="actions">
              <button id="btn-generate" class="btn big-generate" type="button">Δημιουργία</button>
            </div>
            <div class="small" style="margin-top:10px">
              Τα αποτελέσματα παραδίδονται στο Telegram chat. Η σελίδα αυτή ξεκινά το task και μετά κλείνει.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // -----------------------------
  // Config
  // -----------------------------
  const API_URL = "/api/grok/generate";
  const COST_PER_RUN = 0.8;

  // Telegram WebApp
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.ready(); }
  const TG_INIT_DATA = tg?.initData || "";

  // Elements
  const promptEl = document.getElementById("prompt");
  const charCount = document.getElementById("charCount");
  const modeEl = document.getElementById("mode");
  const arEl = document.getElementById("ar");
  const toneEl = document.getElementById("tone");
  const btnGenerate = document.getElementById("btn-generate");
  const btnReset = document.getElementById("btn-reset");
  const costValue = document.getElementById("costValue");

  function showAlert(msg){
    if (tg?.showAlert) tg.showAlert(msg);
    else alert(msg);
  }

  function showSentPopup(){
    if (!tg?.showPopup) return;
    tg.showPopup({
      title: "Telegram",
      message: "Η αίτηση στάλθηκε. Το αποτέλεσμα θα έρθει μέσα στο Telegram.",
      buttons: [{ type: "ok", text: "Close" }]
    }, () => {});
  }

  async function safeJson(res){
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { raw: txt }; }
  }

  promptEl.addEventListener("input", () => {
    charCount.textContent = String(promptEl.value.length);
  });

  btnReset.addEventListener("click", () => {
    promptEl.value = "";
    charCount.textContent = "0";
    modeEl.value = "text";
    arEl.value = "1:1";
    toneEl.value = "spicy";
  });

  btnGenerate.addEventListener("click", async () => {
    const prompt = (promptEl.value || "").trim();
    if (!prompt) return showAlert("Γράψε prompt.");

    if (!TG_INIT_DATA) {
      return showAlert("Άνοιξέ το μέσα από Telegram (WebApp), όχι από browser.");
    }

    btnGenerate.disabled = true;
    btnGenerate.style.opacity = "0.75";

    showSentPopup();

    try {
      const payload = {
        initData: TG_INIT_DATA,
        prompt,
        aspect_ratio: arEl.value,
        tone: toneEl.value,
        mode: modeEl.value
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await safeJson(res);

      if (!res.ok || data?.ok === false) {
        const msg = data?.error || data?.detail || data?.message || "Αποτυχία";
        throw new Error(msg);
      }

      if (tg?.close) tg.close();

    } catch (e) {
      showAlert("Αποτυχία. " + (e?.message || ""));
    } finally {
      btnGenerate.disabled = false;
      btnGenerate.style.opacity = "1";
    }
  });

  // init
  costValue.textContent = String(COST_PER_RUN);
</script>
</body>
</html>
