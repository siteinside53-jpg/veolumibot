<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeoLumi â€“ Î ÏÎ¿Ï†Î¯Î»</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#14161c;
      --stroke:rgba(255,255,255,.08);
      --text:#fff;
      --muted:rgba(255,255,255,.65);
      --purple:#7b2cff;
      --purple2:#6a22ff;
      --shadow:0 18px 45px rgba(0,0,0,.38);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 80% 20%, rgba(123,44,255,.18), transparent 60%),
        radial-gradient(900px 600px at 10% 80%, rgba(123,44,255,.12), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:560px;margin:0 auto;padding:16px 14px 92px}

    /* top user card */
    .user{
      display:flex;align-items:center;gap:12px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .avatar{
      width:44px;height:44px;border-radius:50%;
      background:linear-gradient(135deg, rgba(123,44,255,.85), rgba(123,44,255,.25));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:none}
    .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .name{font-weight:850;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small{font-size:12px;color:var(--muted)}
    .credits{
      margin-left:auto;
      display:flex;flex-direction:column;align-items:flex-end;gap:2px;
    }
    .credits .num{font-size:22px;font-weight:900;line-height:1}

    .section{
      margin-top:14px;
      background:rgba(255,255,255,.02);
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:14px;
    }
    .h1{margin:0;font-weight:900;font-size:18px}
    .sub{margin-top:4px;font-size:13px;color:var(--muted)}
    .btn-secondary{
      width:100%;
      margin-top:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:14px 14px;
      border-radius:16px;
      font-weight:800;
    }

    /* carousel plans */
    .h2{margin:16px 2px 10px;font-weight:900;font-size:18px}
    .carousel{
      display:flex;gap:12px;overflow:auto;
      padding:10px 2px 6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .plan{
      min-width:290px;
      scroll-snap-align:start;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--stroke);
      border-radius:22px;
      padding:14px;
      box-shadow:var(--shadow);
    }
    .plan-title{font-size:18px;font-weight:900}
    .plan-desc{margin-top:3px;font-size:13px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .pill{
      padding:7px 10px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      font-weight:850;
      font-size:13px;
    }
    .more{
      width:100%;margin-top:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:13px 14px;
      border-radius:16px;
      font-weight:850;
    }
    .buy{
      width:100%;
      margin-top:10px;
      border:none;
      background:linear-gradient(90deg, var(--purple), var(--purple2));
      color:#fff;
      padding:14px 14px;
      border-radius:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .buy-ghost{
      width:100%;
      margin-top:8px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:13px 14px;
      border-radius:16px;
      font-weight:900;
    }

    /* bottom tabs */
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      background:rgba(12,13,18,.92);
      border-top:1px solid var(--stroke);
      backdrop-filter:blur(12px);
      padding:10px 14px 12px;
    }
    .tabs-inner{max-width:560px;margin:0 auto;display:flex;gap:10px}
    .tab{
      flex:1;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 10px;
      border-radius:16px;
      font-weight:900;
      text-align:center;
      user-select:none;
    }
    .tab.active{
      border-color:rgba(123,44,255,.45);
      background:rgba(123,44,255,.14);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- User header -->
    <div class="user">
      <div class="avatar" id="avatarBox">
        <img id="avatarImg" alt="avatar" />
        <span id="avatarLetter">V</span>
      </div>

      <div class="meta">
        <div class="name" id="name">VeoLumi</div>
      </div>

      <div class="credits">
        <div class="small">Credits</div>
        <div class="num" id="credits">â€”</div>
      </div>
    </div>

    <!-- Current plan -->
    <div class="section">
      <div class="h1">Î¤ÏÎ­Ï‡Î¿Î½ Ï€Î±ÎºÎ­Ï„Î¿</div>
      <div class="sub">Î”Ï‰ÏÎµÎ¬Î½</div>

      <button class="btn-secondary" onclick="openCreditsInfo()">
        Î‘Î³Î¿ÏÎ¬ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ credits
      </button>

      <div class="sub" style="margin-top:10px">
        Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€Î±ÎºÎ­Ï„Î¿. Î Î»Î·ÏÏ‰Î¼Î® Î¼Îµ ÎºÎ¬ÏÏ„Î± Î® crypto.
      </div>
    </div>

    <!-- Subscriptions -->
    <div class="h2">Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚</div>

    <div class="carousel">
      <!-- 1Î· ÎºÎ¬ÏÏ„Î± Free (ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Ï†Ï‰Ï„ÏŒ, Î¼Îµ dynamic credits) -->
      <div class="plan">
        <div class="plan-title">Free</div>
        <div class="row">
          <span class="pill" id="freeCreditsPill">Credits: â€”</span>
          <span class="pill">Î”Ï‰ÏÎµÎ¬Î½</span>
        </div>

        <div class="plan-desc" style="margin-top:12px;line-height:1.3">
          âœ“ ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Ï„Î­Î»Î± Î¼Îµ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚<br/>
          âœ“ Nano Banana, Midjourney, Flux Îº.Î¬.
        </div>

        <button class="more" onclick="showIncludes('Free', 'âœ“ ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Ï„Î­Î»Î± Î¼Îµ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚\\nâœ“ Nano Banana, Midjourney, Flux Îº.Î¬.')">
          Î¤Î¹ Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î¿ Ï€Î±ÎºÎ­Ï„Î¿
        </button>
      </div>

      <!-- Î¤Î± Î´Î¹ÎºÎ¬ ÏƒÎ¿Ï… packs -->
      {% for p in packs %}
      <div class="plan">
        <div class="plan-title">{{ p.title }}</div>
        <div class="plan-desc">{{ p.desc }}</div>

        <div class="row">
          <span class="pill">Credits: {{ p.credits }}</span>
          <span class="pill">{{ "%.2f"|format(p.amount_eur) }}â‚¬</span>
        </div>

        <button class="more" onclick="showIncludes('{{ p.title|e }}', '{{ p.desc|e }}')">
          Î¤Î¹ Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹
        </button>

        <button class="buy" onclick="buyStripe('{{ p.sku }}')">
          Î‘Î³Î¿ÏÎ¬ Î¼Îµ ÎºÎ¬ÏÏ„Î±
        </button>

        <button class="buy-ghost" onclick="buyCrypto('{{ p.sku }}')">
          Î‘Î³Î¿ÏÎ¬ Î¼Îµ Crypto
        </button>
      </div>
      {% endfor %}
    </div>

  </div>

  <!-- Bottom tabs -->
  <div class="tabs">
    <div class="tabs-inner">
      <div class="tab active" id="tab_profile" onclick="switchTab('profile')">ğŸ‘¤ Î¤Î¿ Ï€ÏÎ¿Ï†Î¯Î» Î¼Î¿Ï…</div>
      <div class="tab" id="tab_aff" onclick="switchTab('aff')">ğŸ¤ Î£Ï…Î½ÎµÏÎ³Î±ÏƒÎ¯Î±</div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;

  if (tg) {
    tg.ready();
    tg.expand();
    tg.setHeaderColor("#0b0c10");
    tg.setBackgroundColor("#0b0c10");

    const u = tg.initDataUnsafe?.user;
    if (u) {
      document.getElementById("name").textContent = u.first_name || "VeoLumi";
      document.getElementById("username").textContent = u.username ? "@"+u.username : "â€”";
      document.getElementById("avatarLetter").textContent = (u.first_name || "V").slice(0,1).toUpperCase();
    }
  }

  function initData(){ return tg ? tg.initData : ""; }

  function popup(title, message){
    if (tg?.showPopup) tg.showPopup({ title, message, buttons: [{type:"ok"}] });
    else alert(title + "\n\n" + message);
  }

  async function loadMe(){
    try{
      const r = await fetch('/api/me', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ initData: initData() })
      });

      if(!r.ok){
        popup("API ÏƒÏ†Î¬Î»Î¼Î±", `/api/me: ${r.status} ${r.statusText}`);
        return;
      }

      const data = await r.json();
      if(!data?.ok){
        popup("API ÏƒÏ†Î¬Î»Î¼Î±", "Î— Î±Ï€Î¬Î½Ï„Î·ÏƒÎ· Î´ÎµÎ½ ÎµÎ¯Ï‡Îµ ok:true");
        return;
      }

      const credits = Number(data.user?.credits ?? 0);
      document.getElementById("credits").textContent = credits.toString();

      const pill = document.getElementById("freeCreditsPill");
      if (pill) pill.textContent = "Credits: " + credits.toString();
    }catch(e){
      popup("JS ÏƒÏ†Î¬Î»Î¼Î±", String(e));
    }
  }

  async function loadAvatar(){
  try{
    const tg = window.Telegram?.WebApp;
    const u = tg?.initDataUnsafe?.user;

    // âœ… 1) Î†Î¼ÎµÏƒÎ· Ï†Ï‰Ï„ÏŒ Î±Ï€ÏŒ Telegram (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
    const direct = u?.photo_url;
    if (direct){
      const img = document.getElementById("avatarImg");
      img.src = direct;
      img.style.display = "block";
      document.getElementById("avatarLetter").style.display = "none";
      return;
    }

    // ğŸ” 2) Fallback ÏƒÏ„Î¿ backend
    const r = await fetch('/api/avatar', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ initData: tg ? tg.initData : "" })
    });

    if(!r.ok) return;

    const data = await r.json();
    const url = data?.url || "";
    if(url){
      const img = document.getElementById("avatarImg");
      img.src = url;
      img.style.display = "block";
      document.getElementById("avatarLetter").style.display = "none";
    }
  }catch(e){}
}

  (async () => {
    await loadMe();
    await loadAvatar();
  })();
</script>        
</body>
</html>
